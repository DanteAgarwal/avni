<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Hamari Sukoon Wali Jagah üïØÔ∏è</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --gold: #d4af37;
      --gold-light: #e6c985;
      --text: #3a3530;
      --text-light: #6b655f;
      --glass-bg: rgba(255, 255, 255, 0.88);
      --glass-border: rgba(212, 175, 55, 0.3);
    }

    body {
      background: linear-gradient(135deg, #f0e9e1 0%, #e2dcd3 100%);
      font-family: 'Inter', sans-serif;
      color: var(--text);
      min-height: 100vh;
      padding: 16px 12px 90px;
      position: relative;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .particle {
      position: fixed;
      width: 2px;
      height: 2px;
      background: var(--gold-light);
      border-radius: 50%;
      opacity: 0.4;
      pointer-events: none;
      animation: float 20s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
      10%, 90% { opacity: 1; }
      100% { transform: translateY(-100vh) translateX(80px); }
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 0 8px;
    }

    .nickname-display {
      background: white;
      border: 1px solid var(--glass-border);
      border-radius: 50px;
      padding: 10px 20px;
      display: inline-block;
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--gold);
      margin-bottom: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.3s;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 26px;
      color: var(--text);
      line-height: 1.2;
    }

    /* Desktop Grid */
    .wall {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      max-width: 100%;
      margin: 0 auto;
      padding: 0 6px;
    }

    @media (min-width: 768px) {
      .wall {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
        max-width: 1200px;
        padding: 0;
      }
      body {
        padding: 24px 16px 80px;
      }
      h1 {
        font-size: 32px;
      }
      .nickname-display {
        font-size: 20px;
        padding: 10px 24px;
      }
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 18px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 5px 16px rgba(0,0,0,0.07);
      min-height: 160px;
    }

    @media (min-width: 768px) {
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 28px rgba(0,0,0,0.12);
        border-color: rgba(212, 175, 55, 0.4);
      }
    }

    /* Badges */
    .type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 20px;
      font-weight: 600;
      z-index: 2;
      background: rgba(212, 175, 55, 0.15);
      color: var(--gold);
    }
    .badge-silent { background: #f0f0f0; color: #777; }
    .badge-night { background: #e9e4f0; color: #6b5b95; }
    .badge-sealed { background: #fff5e6; color: var(--gold); }

    /* Content */
    .note-content {
      font-style: italic;
      color: var(--text);
      line-height: 1.7;
      font-size: 15px;
      position: relative;
      word-break: break-word;
    }
    .note-content::before {
      content: '"';
      position: absolute;
      top: -5px;
      left: -5px;
      font-size: 40px;
      color: rgba(212, 175, 55, 0.08);
      font-family: Georgia, serif;
    }

    .poetry-card {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      color: var(--text);
      line-height: 1.8;
      letter-spacing: 0.4px;
      position: relative;
      word-break: break-word;
    }
    .poetry-card::before {
      content: '‚úçÔ∏è';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 18px;
      opacity: 0.15;
    }
    .poetry-card::after {
      content: "‚Äî ‡§ú‡•ã ‡§ú‡§º‡•Å‡§¨‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§π ‡§™‡§æ‡§à";
      display: block;
      margin-top: 14px;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      color: var(--text-light);
      font-style: italic;
      text-align: right;
    }

    /* Sealed */
    .sealed-placeholder {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 100%;
      color: var(--text-light);
      padding: 10px;
    }
    .sealed-placeholder i {
      font-size: 36px;
      margin-bottom: 10px;
      opacity: 0.7;
    }

    /* Empty */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 16px;
      color: var(--text-light);
    }
    .empty-state i {
      font-size: 40px;
      opacity: 0.6;
      display: block;
      margin-bottom: 16px;
    }

    /* Universal Input Panel */
    .input-modal {
      position: fixed;
      z-index: 1000;
    }

    /* Mobile: Bottom Sheet */
    @media (max-width: 767px) {
      .input-modal {
        bottom: 0;
        left: 0;
        right: 0;
      }
      .fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        z-index: 1001;
      }
      .input-panel {
        background: white;
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
        padding: 20px 16px 24px;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.12);
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-height: 80vh;
        overflow-y: auto;
      }
      .input-panel.active {
        transform: translateY(0);
      }
    }

    /* Desktop: Floating Panel */
    @media (min-width: 768px) {
      .input-modal {
        bottom: 20px;
        right: 20px;
      }
      .fab {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--gold);
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(212, 175, 55, 0.4);
        transition: all 0.3s;
        z-index: 1001;
      }
      .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
      }
      .input-panel {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 360px;
        background: white;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        transform: translateY(20px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s;
      }
      .input-panel.active {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
      }
    }

    .input-panel h3 {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      margin-bottom: 14px;
      color: var(--text);
      text-align: center;
    }

    .mode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      background: #f9f7f3;
      padding: 6px;
      border-radius: 12px;
    }
    .mode-tab {
      flex: 1;
      padding: 10px 4px;
      font-size: 14px;
      border: none;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .mode-tab.active {
      background: var(--gold);
      color: white;
    }

    .type-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .type-btn {
      padding: 6px 14px;
      font-size: 13px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .type-btn.active {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.15);
      font-weight: 600;
      color: var(--gold);
    }

    textarea, input {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 14px;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      margin-bottom: 16px;
      transition: border 0.3s;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    textarea:focus, input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    }

    .btn-row {
      display: flex;
      gap: 12px;
    }
    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-outline {
      background: #f8f6f2;
      color: var(--text);
    }
    .btn-fill {
      background: var(--gold);
      color: white;
    }
    .btn:hover {
      opacity: 0.95;
    }

    .saved-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4caf50;
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 15px;
      font-weight: 600;
      opacity: 0;
      transform: translateX(120px);
      transition: all 0.4s;
      z-index: 2000;
      box-shadow: 0 4px 14px rgba(0,0,0,0.22);
    }
    .saved-indicator.show {
      opacity: 1;
      transform: translateX(0);
    }

    /* Safe areas for iPhone */
    @supports (padding-top: env(safe-area-inset-top)) {
      @media (max-width: 767px) {
        body {
          padding-bottom: calc(90px + env(safe-area-inset-bottom));
        }
        .fab {
          bottom: calc(24px + env(safe-area-inset-bottom));
        }
      }
    }
  </style>
</head>
<body>

<div class="saved-indicator" id="savedIndicator">Saved ‚úì</div>

<div class="header">
  <div class="nickname-display" id="nicknameDisplay">Yahan dabao...</div>
  <h1>Hamari Sukoon Wali Jagah</h1>
</div>

<div class="wall" id="wall"></div>

<!-- Unified Input System -->
<div class="input-modal">
  <div class="input-panel" id="inputPanel">
    <div class="mode-tabs">
      <button class="mode-tab active" data-mode="note">üìù Note</button>
      <button class="mode-tab" data-mode="poetry">üñãÔ∏è Poetry</button>
    </div>

    <div class="type-selector" id="noteTypes">
      <button class="type-btn active" data-type="normal">üí¨ Baatein</button>
      <button class="type-btn" data-type="silent">ü§´ Quiet</button>
      <button class="type-btn" data-type="night">üåô Raat</button>
      <button class="type-btn" data-type="sealed">üîí Sealed</button>
    </div>

    <textarea id="entryText" placeholder="‡§ú‡•ã ‡§¶‡§ø‡§≤ ‡§®‡•á ‡§ï‡§π‡§æ..." rows="4"></textarea>
    
    <input type="date" id="unlockDate" style="display:none;" />

    <div class="btn-row">
      <button class="btn btn-outline" id="cancelBtn">Cancel</button>
      <button class="btn btn-fill" id="saveBtn">Save</button>
    </div>
  </div>
  <button class="fab" id="fab">+</button>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabaseUrl = 'https://gwpydutbemgxxxbtxgmj.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3cHlkdXRiZW1neHh4YnR4Z21qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODM1NTUsImV4cCI6MjA4MDE1OTU1NX0.PmIMiIsQtigqSUUeaAcKtmsYfE5ake6dvQMRO4YV91w';
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  // DOM
  const wall = document.getElementById('wall');
  const fab = document.getElementById('fab');
  const inputPanel = document.getElementById('inputPanel');
  const entryText = document.getElementById('entryText');
  const unlockDate = document.getElementById('unlockDate');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const modeTabs = document.querySelectorAll('.mode-tab');
  const typeBtns = document.querySelectorAll('.type-btn');
  const noteTypes = document.getElementById('noteTypes');
  const nicknameDisplay = document.getElementById('nicknameDisplay');

  // State
  let currentMode = 'note';
  let currentNoteType = 'normal';

  // Nicknames
  const nicknames = [
    "Meri Sukoon", "Silent Magic", "Yaad ki Raani", "Little Storm",
    "Tumhara Phir?", "Meri Saanth", "My 'Aapko Pata Nhi'",
    "Angry Switch", "Koot Dungi Express", "Soft Chaos",
    "Silent Symphony", "Meri Shaanti", "Calendar Queen",
    "Dil Ka Haal", "Pyaari Si Musibat", "Meethi Gussa",
    "Chup Chaap Toofan", "Meri Zindagi"
  ];

  // Nickname
  function generateNickname() {
    const name = nicknames[Math.floor(Math.random() * nicknames.length)];
    nicknameDisplay.textContent = `"${name}"`;
  }
  nicknameDisplay.addEventListener('click', generateNickname);
  generateNickname();

  // Open panel
  fab.addEventListener('click', () => {
    inputPanel.classList.add('active');
    // Auto-focus on mobile
    if (window.innerWidth <= 767) {
      setTimeout(() => entryText.focus(), 300);
    }
  });

  // Close panel
  cancelBtn.addEventListener('click', () => {
    inputPanel.classList.remove('active');
  });

  // Close on outside click (desktop)
  document.addEventListener('click', (e) => {
    if (window.innerWidth > 767 && inputPanel.classList.contains('active') && 
        !inputPanel.contains(e.target) && e.target !== fab) {
      inputPanel.classList.remove('active');
    }
  });

  // Mode tabs
  modeTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      modeTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentMode = tab.dataset.mode;

      if (currentMode === 'note') {
        noteTypes.style.display = 'flex';
        updateNoteType('normal');
      } else {
        noteTypes.style.display = 'none';
        entryText.placeholder = "‡§ï‡•Å‡§õ ‡§≤‡§ø‡§ñ‡•ã... ‡§ú‡•ã ‡§¶‡§ø‡§≤ ‡§®‡•á ‡§ï‡§π‡§æ, ‡§™‡§∞ ‡§ú‡§º‡•Å‡§¨‡§æ‡§® ‡§®‡•á ‡§®‡§π‡•Ä‡§Ç";
        unlockDate.style.display = 'none';
        entryText.disabled = false;
      }
    });
  });

  // Note types
  function updateNoteType(type) {
    typeBtns.forEach(btn => {
      if (btn.dataset.type === type) btn.classList.add('active');
      else btn.classList.remove('active');
    });
    currentNoteType = type;

    if (type === 'sealed') {
      unlockDate.style.display = 'block';
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      unlockDate.min = tomorrow.toISOString().split('T')[0];
    } else {
      unlockDate.style.display = 'none';
    }

    if (type === 'night') {
      const now = new Date();
      const hour = now.getHours();
      if (hour < 20 && hour >= 6) {
        entryText.placeholder = "üåô Raat ki diary sirf 8PM‚Äì6AM likhi jaati hai";
        entryText.disabled = true;
      } else {
        entryText.placeholder = "‡§Ü‡§ú ‡§∞‡§æ‡§§ ‡§ï‡§æ ‡§ñ‡•ç‡§Ø‡§æ‡§≤...";
        entryText.disabled = false;
      }
    } else {
      entryText.disabled = false;
      entryText.placeholder = "‡§ú‡•ã ‡§¶‡§ø‡§≤ ‡§®‡•á ‡§ï‡§π‡§æ...";
    }
  }

  typeBtns.forEach(btn => {
    btn.addEventListener('click', () => updateNoteType(btn.dataset.type));
  });

  // Save
  saveBtn.addEventListener('click', async () => {
    const text = entryText.value.trim();
    if (!text) return;

    let error;
    if (currentMode === 'note') {
      if (currentNoteType === 'night') {
        const now = new Date();
        const hour = now.getHours();
        if (hour < 20 && hour >= 6) {
          alert("üåô Raat ki diary sirf raat mein (8PM‚Äì6AM) likhi ja sakti hai.");
          return;
        }
      }

      let insertData = { message: text, type: currentNoteType };
      if (currentNoteType === 'sealed') {
        const date = unlockDate.value;
        if (!date) {
          alert("üîí Kripya kholne ki tarikh chunen.");
          return;
        }
        insertData.unlock_date = date;
      }
      ({ error } = await supabase.from('notes').insert([insertData]));
    } else {
      ({ error } = await supabase.from('poetry').insert([{ lines: text }]));  
    }

    if (!error) {
      entryText.value = '';
      inputPanel.classList.remove('active');
      showSaved();
      renderWall();
    }
  });

  // Show saved
  function showSaved() {
    const el = document.getElementById('savedIndicator');
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2200);
  }

  // Create cards
  function createNoteCard(item) {
    const card = document.createElement('div');
    card.className = 'card';
    
    if (item.type === 'silent') card.style.background = 'rgba(249, 247, 243, 0.9)';
    else if (item.type === 'night') card.style.background = 'rgba(245, 242, 236, 0.9)';
    else if (item.type === 'sealed') card.style.background = 'rgba(252, 250, 244, 0.9)';

    if (item.type !== 'normal') {
      const badge = document.createElement('div');
      badge.className = `type-badge badge-${item.type}`;
      badge.textContent = item.type === 'silent' ? 'ü§´' : item.type === 'night' ? 'üåô' : 'üîí';
      card.appendChild(badge);
    }

    if (item.type === 'sealed') {
      const today = new Date();
      const unlock = new Date(item.unlock_date);
      if (unlock > today) {
        const div = document.createElement('div');
        div.className = 'sealed-placeholder';
        const dateStr = new Date(item.unlock_date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        div.innerHTML = `<i>üîí</i><div>Is sandesh ko kholne ke liye<br>${dateStr} ka intezaar hai</div>`;
        card.appendChild(div);
      } else {
        const content = document.createElement('div');
        content.className = 'note-content';
        content.textContent = item.message;
        card.appendChild(content);
      }
    } else {
      const content = document.createElement('div');
      content.className = 'note-content';
      content.textContent = item.message;
      card.appendChild(content);
    }
    return card;
  }

  function createPoetryCard(item) {
    const card = document.createElement('div');
    card.className = 'card poetry-card';
    card.textContent = item.lines;
    return card;
  }

  // Render
  async function renderWall() {
    wall.innerHTML = '';

    try {
      const [notesRes, poetryRes] = await Promise.all([
        supabase.from('notes').select('*').order('created_at', { ascending: false }),
        supabase.from('poetry').select('*').order('created_at', { ascending: false })
      ]);

      const notes = (notesRes.data || []).map(n => ({ ...n, source: 'note' }));
      const poetry = (poetryRes.data || []).map(p => ({ ...p, source: 'poetry' }));

      const all = [...notes, ...poetry].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      if (all.length === 0) {
        wall.innerHTML = `<div class="empty-state"><i>üïØÔ∏è</i><p>‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§≠‡•Ä ‡§ñ‡§æ‡§Æ‡•ã‡§∂‡•Ä ‡§π‡•à...<br>‡§™‡§∞ ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§§ ‡§á‡§∏‡•á ‡§ú‡•Ä‡§µ‡§Ç‡§§ ‡§ï‡§∞ ‡§¶‡•á‡§ó‡•Ä</p></div>`;
        return;
      }

      all.forEach(item => {
        const card = item.source === 'poetry' 
          ? createPoetryCard(item) 
          : createNoteCard(item);
        wall.appendChild(card);
      });
    } catch (err) {
      console.error('Render error:', err);
      wall.innerHTML = `<div class="empty-state">‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ï‡•ç‡§ï‡§§... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§</div>`;
    }
  }

  // Realtime
  supabase
    .channel('wall-updates')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'notes' }, () => renderWall())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'poetry' }, () => renderWall())
    .subscribe();

  // Particles
  for (let i = 0; i < 10; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = `${Math.random() * 100}%`;
    p.style.animationDelay = `${Math.random() * 20}s`;
    p.style.animationDuration = `${20 + Math.random() * 10}s`;
    document.body.appendChild(p);
  }

  // Init
  renderWall();
</script>

</body>
</html>